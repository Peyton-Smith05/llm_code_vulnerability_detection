# LAVA 

* Research paper: [LAVA: Large-Scale Automated Vulnerability Addition](https://ieeexplore.ieee.org/document/7546498)

* Repository: [LAVA: Large Scale Automated Vulnerability Addition](https://github.com/panda-re/lava)

LAVA is a research paper we came across that seeks to inject bugs into already functional code. We were interested in this as a dataset to finetune a LLM because it had a "buggy" code example and "corrected" code example as the bug injection and the original file respectively. 

## Setting Up LAVA

### Setting Up a VM

Assuming this is being done on the Hulk server, I used a vagrant VM. Vagrant should already be installed but the steps to set up an Ubuntu 16.04 vm are as follows. 

* `sudo apt-get update`
* `sudo apt-get install vagrant`
* `mkdir vagrant-vm`
* `cd vagrant-vm`
* `vagrant init ubuntu/xenial64`
* Edit the vagrant file for the VM to have at least 32 GB of RAM.
* `vagrant up`
* `vagrant ssh`

### Running LAVA on the VM

* Navigate the the repository [here](https://github.com/panda-re/lava). 

* Under the "Quick Start" section in the README, there is a link to the `docs/setup.md`. Navigate to it and follow the instructions on the document in the vagrant vm. 

    * All of the commands work up until you reach the `python2 setup.py`. Here the DockerFile needs to be changed to work with an older version of PyYAML.

    * Navigate to `docker/Dockerfile` in your cloned repository. On line 65 the line `RUN pip install pyyaml` needs to be changed to `RUN pip install pyyaml==5.1`. This makes it install an older version to work with python2. 

* After this follow the rest of the instructions on README.md to finish the installation of the project. 

* Run `./scripts/lava/.sh toy`, `./scripts/lava/.sh blecho`, `./scripts/lava/.sh libyaml`, etc. to get buggy copies of all preformatted projects. 

* Note: The script makes multiple rounds of injections an stores them in a git branch. 

## Understanding LAVA Output

The git project can be found in `lava/target_injections/toy/bugs/0/toy/` if you have run the script on toy. From there `git checkout build1` will give you the first injected copy. 

The corresponding injection log can be found in `target_injections/toy/logs/inject-1.log`. This log contains line numbers of all injected bugs in the corresponding commit. 

Towards the end of the file contains output corresponding with whether or not the bug was validated as to actually cause an error.

## Extracting the LAVA Data

Once the project has been setup and all projects have had bugs injected into them, add `parse_lava_data.py` to the `/lava` directory. Install all dependencies for the script and run `python2 parse_lava_data.py`. You will have file titled `data.csv` from the script. The script collected all of the line numbers from where the bug was injected, accessed the git branch that has those changes, collected the good and bad code from those sections, and saved it to a csv. 

The `lava/data` folder in this repository has the what I extracted from my setup of LAVA. I also split it into train and test and tried formatting it in the Llama2 conversation model.
